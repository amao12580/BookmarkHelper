<html>
<!--Harry Guo: 本网页是手机QQ浏览器调试项设置界面-->
<!--要增加调试项，1. 在form标签中增加一个子标签，配置好属性；2. 在script标签中增加一个方法，供修改设置时调用；3. 在浏览器中增加设置、获取设置项状态的接口，供js调用-->
<head>
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.7"/>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>调试开关</title>
	<style type="text/css">
	.tipsStyle 
	{
		font-size: 9px;
		color: #FFFFFF;
		-webkit-border-radius:3px;
		background: -webkit-gradient(linear, 0 0, 0 100%, from(#bcbcbc), to(#5c5c5c));
	}
	body 
	{
		background-color: #FFFFFF;
	}
	.borderRadius 
	{
		-webkit-border-radius:10px;
		background-color: #EFEFEF;
		border:1px solid #C9CACA
	}
	table 
	{
	  white-space: normal;
	  line-height: normal;
	  font-weight: normal;
	  font-size: small;
	}
	</style>
</head>

<!--页面加载完成后需要initStatus()，用来更新设置项状态-->
<body  style="font-size:12px">
<!--这里是所有设置项-->
<div>
<table class="borderRadius"  bgcolor="#FFFFFF" width="100%" cellspacing="0" bordercolor="#AAABA0" style="font-size:10px">

<td>&nbsp;&nbsp;</td>

<td>
<br>

<input id="id_enableX5ProxyByForce" alt="强制云加速" type="checkbox" name="强制云加速" onclick="setEnableX5ProxyByForce(this.checked)"/>强制云加速
<br>

<input id="id_directconnectionbyforce" alt="强制走直连" type="checkbox" name="强制走直连" onclick="setDirectConnectByForce(this.checked)"/>强制走直连

<hr height="3">

<table>
<tr>
<td>
<input id="id_subres_img" alt="" type="checkbox" style="font-size:10px" />Image
</td>

<td>
<input id="id_subres_css" alt="" type="checkbox" style="font-size:7px" />CSS
</td>

<td> 
<input id="id_subres_js" alt="" type="checkbox" style="font-size:7px" />JS
</td>
</tr>

<tr>
<td>
<input id="id_force_direct" type="submit" name="nameapplyip" value="直连"onclick="subresourceDirect()"/>
</td>

<td></td>

<td>
<input id="id_end_determine" type="submit" name="nameapplyip" value="默认"onclick="subresourceDefault()"/>
</td>

</tr>
</table>
</td>
</tr>
</table>

<br>
&nbsp;代理IP地址：
<br>
<table  class="borderRadius"  bgcolor="#FFFFFF" width="100%" cellspacing="2" bordercolor="#AAABA0" style="font-size:10px">

<tr>
<td>&nbsp;</td>
<td colspan="2">
<select id="iplistselect">
</select>
</td>
</tr>
<tr>
<td> &nbsp;&nbsp;&nbsp;&nbsp;</td>
<td colspan="2">
<input id="targetipaddress" width = "100%" type="text" name="targetipaddress" value=""/>
</td>
</tr>
<tr>
<td> &nbsp;&nbsp;&nbsp;&nbsp;</td>
<td>
<input id="addip" type="submit" name="" value="增加" onclick="addipaddr()"/>
</td>
<td>
<input id="delip" type="submit" name="" value="删除"onclick="delipaddr()"/>
</td>
</tr>
<tr>
<td> &nbsp;&nbsp;&nbsp;&nbsp;</td>
<td>
<input id="applyip" type="submit" name="" value="应用"onclick="applyaddr()"/>
</td>
<td>
<input id="id_reset_proxy" type="submit" name="" value="重置"onclick="resetProxyAddr()"/>
</td>
</tr>
</table>

<br>
&nbsp;直连代理状态检测

<br>
<table  class="borderRadius"  bgcolor="#FFFFFF" width="100%" cellspacing="2" bordercolor="#AAABA0" style="font-size:10px">
<tr>
<td>&nbsp;
</td>
<td>
<br>
URL地址：
<br>

<input type="text" id="directurl" value="http://3g.qq.com/" style=" height: 26px; font-size: 13px; width: 100%; ">
<br>
<br>

<input type="button" onclick="checkProxyStatus()" value="提  交" style=" height: 26px; font-size: 13px; ">

<br>
<h3 id="conclusion"></h3> 

<h3 id = "reason" style="color:red"></h3>
<br>
</td>
<td>&nbsp;
</td>
</tr>
</table>

<br>

<table class="borderRadius"  bgcolor="#FFFFFF" width="100%" cellspacing="0" bordercolor="#AAABA0" style="font-size:10px">
<tr>
<td>&nbsp;</td>
<td>
<br>
&nbsp;WUP地址：
<input id="id_setwupaddress" placeholder="填写WUP地址 ip:port" style="display:inline" type="text"/> 
<input id="" type="submit" name="namedelip" value="应用" style="display:inline"  onclick="applyWupAddr()"/>
<hr height="3">
&nbsp;广告过滤地址：
<input id="id_setadfilterdomain" placeholder="广告过滤 http://ip:port"  type="text"  value=""/> 
<input id="delip" type="submit" name="namedelip" value="应用"  onclick="applyADFilterServer()"/> &nbsp;&nbsp; &nbsp; <input id="" type="submit" name="nameapplyip" value="清除过滤缓存"onclick="clearAdCache()"/>
<br>
</td>
</tr>
</table>
<!--
<br>
<table class="borderRadius"  bgcolor="#FFFFFF" width="100%" cellspacing="0" bordercolor="#AAABA0" style="font-size:10px">
<tr>
<td>&nbsp;</td>

<td> 

<input id="id_clearcookie" alt="" type="checkbox" name="Cookie" onclick="setServerAllowX5Proxy(this.checked)"/>Cookie
<br>
<input id="id_clearfilecache" alt="" type="checkbox" name="文件缓存" onclick="setServerAllowX5Proxy(this.checked)"/>文件缓存
<br>

<input id="id_clearadfiltercache" alt="" type="checkbox" name="广告过滤缓存" onclick="setServerAllowX5Proxy(this.checked)"/>广告过滤缓存
<br>
</td>
<td>
<input id="" type="submit" name="nameapplyip" value="清除"onclick="clearCookieAndCache()"/>
</td>
</tr>
</table>
-->

<br>
<table class="borderRadius"  bgcolor="#FFFFFF" width="100%" cellspacing="5" bordercolor="#AAABA0" style="font-size:10px">

<tr>
<td>GUID:</td>
</tr>

<tr>


<td id = "guid_id">null</td>
</tr>

<tr> 
<td ><hr></td>
</tr>

<tr>
<td>QUA:</td>
</tr>
<tr>
<td id="qua_id">null</td>
</tr>
</table>

</div>

<!--这里是给用户的tips提示（某开关已经开启/关闭）-->
<div align="right" style="position:fixed; bottom:10px; color:Blue; font-size:8px">
<table id="tipsBack" height="23" border="0" cellpadding="0" cellspacing="0" style="display:none">
<tr>
<td width="9" background="left.png"></td>
<td background="middle.png"><p class="tipsStyle" id="resultTips" align="right"></p></td>
<td width="13" background="right.png"></td>
</tr>
</table>
</div>

<!--所有代码逻辑都是在这段js里面做的-->
<script type="text/javascript">
	
	initStatus();
	//****************************************************页面初始化部分****************************************************/
	function initStatus()					// 初始化设置项状态
	{
		firstBlockInit();
		displayGUIDAndQUAs();
		parseProxyList();
		getSubresourceDirect();
		checkProxyStatus();
	}

	function firstBlockInit()
	{
		// 通过js2java获取浏览器现存的设置项状态
		if((typeof(window.ProxyStatus) == "undefined") || (typeof(window.ProxyStatus.getConnectStatus) == "undefined"))
		{
			alert("功能接口添加失败，请退出重新进入");
			return;
		}

		var x5ConnectStatusCode 			=  window.ProxyStatus.getConnectStatus();
		// 初始化设置项状态
		document.getElementById("id_enableX5ProxyByForce").checked    =  (x5ConnectStatusCode == 1);
		document.getElementById("id_directconnectionbyforce").checked 		=   (x5ConnectStatusCode == -1 );
	}

	//****************************************************网络代理/加密部分****************************************************/
	function setEnableX5ProxyByForce(enable)				// 强制开启云加速开关
	{
		window.ProxyStatus.setEnableX5ProxyByForce(enable);
		firstBlockInit();
		resultTips("强制开启云加速已"+(enable == true ? "开启":"关闭"), 1000);
	}

	function setDirectConnectByForce(enable)				// 强制开启走直连开关
	{
		window.ProxyStatus.setDirectConnectByForce(enable);
		firstBlockInit();
		resultTips("强制开启走直连已"+(enable == true ? "开启":"关闭"), 1000);
	}

	//****************************************************Util 部分****************************************************/
	// 判断是否IP地址
	function isIPAddress(str)
	{
		if (str == null || str == "")
		    return false;
		var pattern = new RegExp("^((\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5]|[*])\\.){3}(\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5]|[*])$");
		return str.match(pattern);
	}

	var tipsTimeoutId = 0;					// tips显示几秒后消失，需要定时器实现
	var opacityInterval = 0;				// 透明度渐隐的timer
	function resultTips(tips, delayTime)
	{
		var tipsElementId		= "resultTips";
		var tipsBackElementId	= "tipsBack";
		var styleOpacity = 1;
		document.getElementById(tipsBackElementId).style.display = "block";  // 显示提示标签
		if (tipsTimeoutId != 0)				// 以前也有该timeout，要取消它
		{
		    clearTimeout(tipsTimeoutId);
		    tipsTimeoutId = 0;
		}
		if (opacityInterval != 0)			// 渐隐的timer不能存在多个
		{
		    clearInterval(opacityInterval);
		    opacityInterval = 0;
		}
		document.getElementById(tipsElementId).innerHTML = "&nbsp;&nbsp;"+tips+"&nbsp;&nbsp;";	     // 弹出提示
		document.getElementById(tipsBackElementId).style.opacity = styleOpacity; // 设置可见度

		// 定时消隐
		tipsTimeoutId = setTimeout(
		        function()
		        {
		            tipsTimeoutId = 0;
		            // 提示文字有渐隐的功能
		            opacityInterval = setInterval(
		            function()
		            {
		                styleOpacity -= 0.2;
		                if (styleOpacity < 0)
		                {	// 取消该interval
		                    clearInterval(opacityInterval);
		                    opacityInterval = 0;
		                    document.getElementById(tipsBackElementId).style.display = "none";
		                    return;
		                }
		                document.getElementById(tipsBackElementId).style.opacity = styleOpacity;
		            }, 50); // 定时消隐
		        }, delayTime);
	}									


	//****************************************************显示GUID/QUA部分****************************************************/
	function displayGUIDAndQUAs()
	{
		document.getElementById("guid_id").innerHTML= window.ProxyStatus.getGUID();
		document.getElementById("qua_id").innerHTML= window.ProxyStatus.getQUA();
	}

	//****************************************************子资源的直连策略部分****************************************************/
	function subresourceDirect()
	{
		var img = document.getElementById("id_subres_img").checked;
		var css = document.getElementById("id_subres_css").checked;
		var js =document.getElementById("id_subres_js").checked;

		var sel = (img? 1:0) + (css? 2:0) + (js?4:0);

		if(sel == 0)
		{
			alert("请勾选要直连的子资源类型。");
			return;
		}

		if( document.getElementById("id_directconnectionbyforce").checked)
		{
			alert("强制走直连被开启, 子资源已经直连。");
			return ;
		}

		window.ProxyStatus.setSubResDirect(sel);
		alert("设置选中的子资源直连成功。");
	}

	function getSubresourceDirect()
	{
		var subResDirect = window.ProxyStatus.getSubResDirect();
		document.getElementById("id_subres_img").checked = (subResDirect & 1);
		document.getElementById("id_subres_css").checked = (subResDirect & 2);
		document.getElementById("id_subres_js").checked = (subResDirect & 4);
	}
	

	function subresourceDefault()
	{
		window.ProxyStatus.setSubResDirect(0);
		getSubresourceDirect();
		alert("恢复后台的连接策略。");
	}
	//*************************************************************************************************************************/

	//****************************************************清除Cookie 缓存，广告部分。****************************************************/
	function clearAdCache()
	{
		window.ProxyStatus.clearAdCache();
		resultTips("广告过滤缓存被清空。" , 1000);

	}
	//*************************************************************************************************************************/
	


	//****************************************************强制设置代理IP地址部分。****************************************************/
	//解析内核保存的代理地址下拉列表内容生成下拉列表。
	function parseProxyList()
	{
		var proxylist = window.ProxyStatus.loadQProxyAddressList();	
		//empty or short, don't add any option.   eg : 1.1.1.1:8
		//有些机型上会在后面增加一个空行，导致判断最多加5个实际IP错误。
		if (proxylist == null || proxylist == "" || proxylist.length < 9)
		{
		         return ;
		}
 		var selectele =  document.getElementById("iplistselect");
 		var hosttring = proxylist.split("=");

 		for(var i =0; i < hosttring.length;i++)
 		{
 			var newip = document.createElement("option");
 			newip.text = hosttring[i];
 			selectele.appendChild(newip);
 		}
 		
	}
	
	//将下拉下表中的数据序列化，返回序列化数据。
	function serializeProxyIPList()
	{
		var selectele =  document.getElementById("iplistselect");
		var allitems = selectele.children;
		var retStr = "";
		for (var i =0 ; i <= allitems.length - 1; i++) 
		{
			if(i >=1 && i <= allitems.length - 1 )
				retStr +="=";
			retStr += allitems[i].value;
		}
		return retStr;
	}

	//处理增加按钮。
	function addipaddr()
	{
	    var addcontent = document.getElementById("targetipaddress").value;
	    addcontent = addcontent.trim();
	    if (addcontent == null || addcontent == "")
	    {
	        alert("IP地址不可为空");
	        return ;
	    }

	    var selectele =  document.getElementById("iplistselect");
	    if(selectele.childElementCount >= 5)
	    {
	        alert("最多可添加5个地址。");
	        return;
	    }

	    for (var i =0 ; i <= selectele.length - 1; i++) 
	    {
	        if (addcontent == selectele[i].value)
	        {
	            alert("已经存在了，请不要重复添加。");
	            return;
	        }
	    }

	    var proxyaddr = addcontent.split(":");

	    if (isIPAddress(proxyaddr[0]) )
	    {
	        var newip = document.createElement("option");
	        newip.text = addcontent;

	        document.getElementById("iplistselect").appendChild(newip);
	        window.ProxyStatus.saveQProxyAddressList(serializeProxyIPList());
	    }
	    else
	    {
	        alert("IP地址不合法。");
	    }
	}

	//删除按钮响应。
	function delipaddr()
	{
	    var selectele =  document.getElementById("iplistselect");
	    var curSelIndex = selectele.selectedIndex ;
	    var allitems = selectele.children;
	    for (var i =0 ; i <= allitems.length - 1; i++) 
	    {
	        if(i == curSelIndex )
	        {
	            selectele.removeChild(allitems[i]);
	            break;
	        }

	    }
	    window.ProxyStatus.saveQProxyAddressList(serializeProxyIPList());
	}

	//应用按钮响应。
	function applyaddr()
	{
	    var selectele =  document.getElementById("iplistselect");
	    var tosetIPAddr = selectele[selectele.selectedIndex].value ;
	  
	    if(tosetIPAddr == null || tosetIPAddr == "")
	    {
	    	alert("请选择合法的IP地址");
	    	return;
	    }

	    var proxyaddr = tosetIPAddr.split(":");

	    
	    window.ProxyStatus.setQProxyAddressIndex(selectele.selectedIndex);
	    alert(proxyaddr[0] + " 代理地址应用成功。" );
		
	}

	//重围按钮响应。
	function resetProxyAddr()
	{
		 window.ProxyStatus.setQProxyAddressIndex(-1);
		 alert("清除代理地址应用成功。" );
	}
	//**************************************************************************************************************************/

	
	//******************************************WUP地址强制设置功能***************************************************************/
	function applyWupAddr()
	{
		var inputcontent = document.getElementById("id_setwupaddress").value;

		if(inputcontent == "")
		{
			window.ProxyStatus.setWupAddressByForce("");
			alert("WUP地址清除成功，恢复默认。");
			return;
		}

		var ipandport1 = inputcontent.split(":");
		if(isIPAddress(ipandport1[0]))
		{
			var addresswup = "http://" + inputcontent;
			window.ProxyStatus.setWupAddressByForce(addresswup);
			alert("新的WUP地址应用成功");
		}
		else
		{
			alert("非法的URL地址");
		}
	}
	//**************************************************************************************************************************/
	
	//**********************************************广告过滤地址设置**************************************************************/
	function applyADFilterServer()
	{
		var adfileteraddr = document.getElementById("id_setwupaddress").value;
		if(adfileteraddr == "")
		{
			window.ProxyStatus.setADFilterAddrByForce("");
			alert("广告过滤地址清除成功，恢复默认。");
			return;
		}
		else if(adfileteraddr.indexOf("http://") < 0)
		{
			alert("非法的URL地址");
		}
		else
		{
			window.ProxyStatus.setADFilterAddrByForce(adfileteraddr);
			alert("广告过滤地址应用成功");
		}
	}
	//**********************************************广告过滤地址设置**************************************************************/

	//**********************************************直连代理状态检测**************************************************************/
	function checkProxyStatus()
	{
		var url = document.getElementById('directurl').value;
		if(typeof(window.ProxyStatus.getDirectConnectReason)!="function")
		{
			return;
		}

		var reason = window.ProxyStatus.getDirectConnectReason(url)

		if(reason.indexOf("应当走云加速")>=0 )
		{
			document.getElementById('conclusion').innerHTML = "当前地址" + url  + " ==========> 走代理。" 
			document.getElementById('reason').innerHTML = "";
		}
		else if(reason.indexOf("非法的URL地址")>=0)
        		{
			document.getElementById('conclusion').innerHTML = "";
			document.getElementById('reason').innerHTML = reason;
      		}
		else
		{
			document.getElementById('conclusion').innerHTML = "当前地址" + url  + " ==========> 走直连，原因如下：</br>";
			document.getElementById('reason').innerHTML = reason;
		}
	}

</script>


</body>
</html>
