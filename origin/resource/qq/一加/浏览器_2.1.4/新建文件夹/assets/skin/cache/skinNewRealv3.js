var skinJS=function(){var skinUl=$('#skinUl');var loading=$("#loading");var globalLoading=$("#globalLoading");loading.hide();var allEle=[];var selectEle=null;var collectHtml=" ";var predef={dataConst:8,empty:{},errFunc:function(){G_helper.errorUploader('script','(使用native接口出错)');},nullFunc:function(){}};if(typeof nativePrivate==="undefined"){try{var nativePrivate={};nativePrivate.ua=navigator.userAgent;nativePrivate.isAndroid=(function(){return/android/ig.test(nativePrivate.ua);})();nativePrivate.isIos=(function(){return/iphone|ipod/ig.test(nativePrivate.ua);})();if(nativePrivate.isAndroid){try{nativePrivate.qua=JSON.parse(mtt.getBrowserParam());}catch(e){G_helper.errorUploader('script','(未使用QQ浏览器)'+e.toString());}
nativePrivate.isx5=(function(){if(nativePrivate.qua.qua.indexOf('ADRQBX5')!=-1){return true;}else{return false;}})();}}catch(e){G_helper.errorUploader('script','(及预定义)'+e.toString());}}
var onSkinSwitch,onSkinUnzip,onSkinDelete;window.x5onSkinSwitch=function(skinID){if(!onSkinSwitch){return;}
onSkinSwitch(skinID);};window.x5onSkinUnzip=function(skinID){if(!onSkinUnzip){return;}
onSkinUnzip(skinID);};window.x5onSkinDelete=function(skinID){if(!onSkinUnzip){return;}
onSkinDelete(skinID);};onSkinUnzip=function(skinID){try{var target=null;_.some(allEle,function(o){if(skinID==o.skinID){target=o;return true;}});if(target&&target.state!='select'){target.state='unselect';target.el.find('.box').removeClass().addClass('box unselect');if(target.skinType==0||target.skinType==1||target.skinType==2){target.el.find('.box').addClass('theme');}}else{return;}}catch(e){G_helper.errorUploader('script','(触发解压完成出错)'+e.toString());}};onSkinSwitch=function(skinID){try{if(selectEle){selectEle.state='unselect';selectEle.el.find('.box').removeClass('select').addClass('unselect');}
var target=null;_.some(allEle,function(o){if(skinID==o.skinID){target=o;return true;}});if(target){target.state='select';target.el.find('.box').removeClass().addClass('box select');if(target.skinType==0||target.skinType==1||target.skinType==2){target.el.find('.box').addClass('theme');}
selectEle=target;}else{selectEle=null;}}catch(e){G_helper.errorUploader('script','(触发换肤出错)'+e.toString());}};onSkinDelete=function(skinID){try{var target=null;_.some(allEle,function(o){if(skinID==o.skinID){target=o;return true;}});if(target&&target.state!='unload'){target.state='unload';target.el.find('.box').removeClass().addClass('box unload');if(target.skinType==0||target.skinType==1||target.skinType==2){target.el.find('.box').addClass('theme');}}else{return;}}catch(e){G_helper.errorUploader('script','(触发解压完成出错)'+e.toString());}};function GetDataParams(tid,from,to,count,page,isEnd,isLoading){this.tid=tid;this.from=from;this.to=to;this.count=count;this.page=page;this.isEnd=isEnd;this.isLoading=isLoading;}
function setGetDataParams(obj,tid,from,to,count,page,isEnd,isLoading){obj.tid=tid;obj.from=from;obj.to=to;obj.count=count;obj.page=page;obj.isEnd=isEnd;obj.isLoading=isLoading;}
var getDataParamsNav=new GetDataParams(0,0,2,3,0,0,0);var getDataParamspage=new GetDataParams(0,0,7,8,1,0,0);_.templateSettings={evaluate:/\{%([\s\S]+?)%\}/g,interpolate:/\{%=([\s\S]+?)%\}/g,escape:/\{%-([\s\S]+?)%\}/g};var firstSkinNav=$("#news_skin_nav");var secondSkinNav=$("#top_skin_nav");var thirdSkinNav=$("#collection_skin_nav");var modBannerNew=$("#mod_banner_new");var modSkinDetail=$("#mod_skin_detail");var modGatherCollect=$("#mod_gather_collect");firstSkinNav.click(function(){firstSkinNav.addClass("current");secondSkinNav.removeClass("current");thirdSkinNav.removeClass("current");modBannerNew.css("display","block");modSkinDetail.css("display","block");modGatherCollect.css("display","none");if(getDataParamspage.page!=1){G_helper.countUploader(1,firstSkinNav.attr('nav-id'),0);allEle=[];skinUl.find("li").remove();setGetDataParams(getDataParamspage,firstSkinNav.attr('nav-id'),0,7,8,1,0,0);initData(getDataParamspage);}});secondSkinNav.click(function(){firstSkinNav.removeClass("current");secondSkinNav.addClass("current");thirdSkinNav.removeClass("current");modBannerNew.css("display","none");modSkinDetail.css("display","block");modGatherCollect.css("display","none");if(getDataParamspage.page!=2){G_helper.countUploader(1,secondSkinNav.attr('nav-id'),0);allEle=[];skinUl.find("li").remove();setGetDataParams(getDataParamspage,secondSkinNav.attr('nav-id'),0,7,8,2,0,0);initData(getDataParamspage);}});thirdSkinNav.click(function(){firstSkinNav.removeClass("current");secondSkinNav.removeClass("current");thirdSkinNav.addClass("current");modBannerNew.css("display","none");modSkinDetail.css("display","none");modGatherCollect.css("display","block");if(getDataParamspage.page!=3){G_helper.countUploader(1,thirdSkinNav.attr('nav-id'),0);var collects=$('#collect');collectHtml=' ';collects.find("li").remove();collects.off('click','li');setGetDataParams(getDataParamspage,thirdSkinNav.attr('nav-id'),0,7,8,3,0,0);initData(getDataParamspage);}});var modMianNavUl=$("#mod_mian_nav_ul");try{nativeAPI.getAppVersion(function(data){var dataReg=data.match(/^\d\.\d/);if(parseFloat(dataReg[0])>=5.5){if(nativePrivate.isAndroid){modMianNavUl.append("<li><a  href='qb://setting/skincustom'>自定义</a></li>");}else if(nativePrivate.isIos){modMianNavUl.append("<li><a  href='mttcommander:customizeskin'>自定义</a></li>");}}},null);}catch(e){G_helper.errorUploader('script','(判断版本失效)');}
var ajax={};ajax.getSkinData=function(getDataParams,callback){try{getDataParams.from=getDataParams.from?getDataParams.from:0;getDataParams.to=getDataParams.to?getDataParams.to:'n';var header={};if(nativePrivate.isAndroid&&nativePrivate.isx5===false){header={"Q-UA":nativePrivate.qua.qua,"Q-GUID":nativePrivate.qua.guid}}
var getDataUrl=location.protocol+'//'+location.host+"/skin/getSkinData";$.ajax({type:'GET',url:getDataUrl,data:{tid:getDataParams.tid,from:getDataParams.from,to:getDataParams.to},dataType:'json',headers:header,success:function(data){callback(1,data);},error:function(){callback(0);}});}catch(e){G_helper.errorUploader('script','(请求皮肤数据报错)'+e.toString());}};var loadData=function(callback,getDataParams){try{if(getDataParams.isLoading==true){return false;}
if(getDataParams.isEnd==1){return false;}
getDataParams.isLoading=1;ajax.getSkinData(getDataParams,function(state,data){try{getDataParams.isLoading=0;if(state==0||!data){G_helper.errorUploader('script','(ajax没有返回数据)');return false;}
if(getDataParams.from==0||getDataParams.tid==0){globalLoading.css("display","none");loading.show();}
if(data.isEnd=='1'){loading.hide();getDataParams.isEnd=1;}
callback(data,getDataParams);}catch(e){G_helper.errorUploader('script','(处理皮肤数据出错)'+e.toString());}});}catch(e){G_helper.errorUploader('script','(拉取皮肤数据封装出错)'+e.toString());}};var composeDateSkin=function(datas,getDataParams){try{var template=_.template($('#skinListTmp').html());var orgSkins=JSON.parse(JSON.stringify(datas.skins));var count=0;var dledSkins;var dlingSkins;var selectID;if(getDataParams.tid==0){if(datas.skins.length<8){loading.hide();}else{loading.show();}}
var composeWithNative=function(){if(count!==3){return;}
var packEl=$();_.each(orgSkins,function(o){o.state='unload';o.oid=getDataParamspage.tid;if(nativePrivate.isAndroid){o.skinID=o.skinName;}
var dom=template(o);o.el=$(dom);_.some(dledSkins,function(id){if(o.skinID==id){o.state='unselect';if(o.skinID==selectID){o.state='select';selectEle=o;}
return true;}});if(o.skinType==0||o.skinType==1||o.skinType==2){o.el.find('.box').addClass('theme');}
if(nativePrivate.isAndroid){var skinLinkUrl=location.protocol+'//'+location.host+'/skin/detail.html?isnewpage=true&titlename='+o.name+'&skinid='+o.realID+'&oid='+o.oid;skinLinkUrl=encodeURI(skinLinkUrl);o.el.find('.skinLink').attr("href",skinLinkUrl);}
o.el.find('.box').addClass(o.state);packEl=packEl.add(o.el);});skinUl.append(packEl);allEle=allEle.concat(orgSkins);};nativeAPI.dledSkinList(predef.empty,function(data){dledSkins=data.split('&');count++;composeWithNative();},predef.errFunc);nativeAPI.dlingSkinList(predef.empty,function(data){dlingSkins=data.split('&');count++;composeWithNative();},predef.errFunc);nativeAPI.useingSkinName(predef.empty,function(data){selectID=data;count++;composeWithNative();},predef.errFunc);}catch(e){G_helper.errorUploader('script','(把皮肤与native结合出错)'+e.toString());}};var composeDateCollect=function(data){try{var collects=$("#collect");var collectTmp=$("#collectTmp").html();for(var i=0;i<data.skinTypes.length;i++){if(nativePrivate.isAndroid){var skinLink=location.protocol+'//'+location.host+'/skin/gather.html?isnewpage=true&titlename='+data.skinTypes[i].name+'&gatherid='+data.skinTypes[i].id+'&oid='+getDataParamspage.tid;data.skinTypes[i].skinLinkUrl=encodeURI(skinLink);}else if(nativePrivate.isIos){data.skinTypes[i].skinLinkUrl='javascript:void(0);';}}
collectHtml=collectHtml+_.template(collectTmp,data);collects.html(collectHtml);if(nativePrivate.isIos){collects.on('click','li',function(e){var id=$(this).attr('collect-id');for(var i=0;i<data.skinTypes.length;i++){if(data.skinTypes[i].id==id){var urlDetail=location.protocol+'//'+location.host+'/skin/gather.html?&gatherid='+data.skinTypes[i].id+'&oid='+getDataParamspage.tid;var options={url:urlDetail,title:data.skinTypes[i].name};nativeAPI.openNewPage(options,predef.nullFunc,predef.nullFunc);}}});}}catch(e){G_helper.errorUploader('script','(把collect与native结合出错)'+e.toString());}};var composeDateBanner=function(data){try{$("#mod_banner_new_a img").attr("src",data.banner[0].img);if(nativePrivate.isAndroid){var skinLink=data.banner[0].link+'&titlename='+data.banner[0].title+'&oid='+getDataParamspage.tid+'&isnewpage=true'+'&t=2';$("#mod_banner_new_a").attr("href",skinLink);}else if(nativePrivate.isIos){var modBannerNewA=$("#mod_banner_new_a");modBannerNewA.unbind('click').click(function(){var urlIos=data.banner[0].link+'&oid='+getDataParamspage.tid+'&t=2';var options={url:urlIos,title:data.banner[0].title};nativeAPI.openNewPage(options,predef.nullFunc,predef.nullFunc);});}}catch(e){G_helper.errorUploader('script','(把banner与native结合出错)'+e.toString());}};var skinsClick=function(){try{skinUl.on('click','li',function(){var id=$(this).attr('skin-id');var target=null;_.some(allEle,function(o){if(id==o.skinID){target=o;return true;}});if(!target){return false;}
if(nativePrivate.isIos){var urlDetail=location.protocol+'//'+location.host+'/skin/detail.html?&skinid='+target.realID+'&oid='+target.oid;var options={url:urlDetail,title:target.skinName};nativeAPI.openNewPage(options,predef.nullFunc,predef.nullFunc);}});}catch(e){G_helper.errorUploader('script','(click事件绑定出错)'+e.toString());}};var composeData=function(data,getDataParams,callback){if(data.dataType==3){window.location.reload();}
if(getDataParams.tid==0){if(data.dataType==0){try{firstSkinNav.text(data.skinTypes[0].name);firstSkinNav.attr('nav-id',data.skinTypes[0].id);secondSkinNav.text(data.skinTypes[1].name);secondSkinNav.attr('nav-id',data.skinTypes[1].id);thirdSkinNav.text(data.skinTypes[2].name);thirdSkinNav.attr('nav-id',data.skinTypes[2].id);getDataParamspage.tid=data.skinTypes[0].id;setGetDataParams(getDataParamspage,firstSkinNav.attr('nav-id'),8,15,8,1,0,0);}catch(e){G_helper.errorUploader('script','(nav结合数据出错)'+e.toString());}}}
try{if(data.skins){composeDateSkin(data,getDataParams);}}catch(e){G_helper.errorUploader('script','(composeDateSkin没有皮肤数据)'+e.toString());}
try{if(data.skinTypes){composeDateCollect(data);}}catch(e){G_helper.errorUploader('script','(composeDateCollect请求皮肤数据报错)'+e.toString());}
try{if(data.banner){composeDateBanner(data);}}catch(e){G_helper.errorUploader('script','(composeDateBanner没有皮肤数据)'+e.toString());}
callback();};var showSkinCache=function(callback,getDataParams){var key=getDataParamsToKey(getDataParams);var skinCache=new LocalStorageCache(key);skinCache.getLocalCache(function(data){callback(data,getDataParams);},function(){callback(0,getDataParams);});};var setSkinCache=function(data,getDataParams){var key=getDataParamsToKey(getDataParams);var skinCache=new LocalStorageCache(key);skinCache.setLocalCache(data,function(){},function(){G_helper.errorUploader('script','设置cache失败');});};var getDataParamsToKey=function(getDataParams){var key="tid"+getDataParams.tid+"from"+getDataParams.from+"to"+getDataParams.to;return key;};var initData=function(getDataParams){if(nativePrivate.isIos||nativePrivate.isAndroid){}else{G_helper.errorUploader('script','(未使用QQ浏览器)');return false;}
if(getDataParams.from==0||getDataParams.tid==0){globalLoading.css("display","block");loading.hide();}
if(getDataParams.tid==0){showSkinCache(function(dataCache,getDataParams){if(dataCache==0){try{loadData(function(data1,getDataParams){try{setSkinCache(data1,getDataParams);composeData(data1,getDataParams,function(){});}catch(e){G_helper.errorUploader('script','结合数据出错'+e.toString());}
getDataParams.from=getDataParams.from+getDataParams.count;getDataParams.to=getDataParams.to+getDataParams.count;},getDataParams);}catch(e){G_helper.errorUploader('script','拉去数据并结合数据出错'+e.toString());}}else{try{composeData(dataCache,getDataParams,function(){try{globalLoading.css("display","none");loadData(function(data2,getDataParams){if(JSON.stringify(dataCache)==JSON.stringify(data2)){}else{allEle=[];skinUl.find("li").remove();composeData(data2,getDataParams,function(){});setSkinCache(data2,getDataParams);}},getDataParams);}catch(e){G_helper.errorUploader('script','拉去数据并结合数据出错'+e.toString());}});}catch(e){G_helper.errorUploader('script','结合数据出错'+e.toString());}
getDataParams.from=getDataParams.from+getDataParams.count;getDataParams.to=getDataParams.to+getDataParams.count;}},getDataParams);}else{try{loadData(function(data3,getDataParams){try{composeData(data3,getDataParams,function(){});}catch(e){G_helper.errorUploader('script','结合数据出错'+e.toString());}
getDataParams.from=getDataParams.from+getDataParams.count;getDataParams.to=getDataParams.to+getDataParams.count;},getDataParams);}catch(e){G_helper.errorUploader('script','拉去数据并结合数据出错'+e.toString());}}};initData(getDataParamsNav);G_helper.countUploader(0,0,0);skinsClick();$(window).on('scroll resize',function(){if(getDataParamspage.tid!=0){if((getDataParamspage.isEnd==1)||getDataParamspage.isLoading){return false;}
var bodyHeight=$('body').height();var winHeight=window.innerHeight;if(bodyHeight-winHeight<$(window).scrollTop()+52){initData(getDataParamspage);}}});};skinJS();