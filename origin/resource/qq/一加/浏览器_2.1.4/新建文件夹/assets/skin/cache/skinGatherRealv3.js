"use strict";var showGather=function(){try{var predef={dataConst:8,empty:{},errFunc:function(){},nullFunc:function(){}}}catch(e){G_helper.errorUploader('script','(skin助手及预定义)'+e.toString());}
if(typeof nativePrivate==="undefined"){try{var nativePrivate={};nativePrivate.ua=navigator.userAgent;nativePrivate.isAndroid=(function(){return/android/ig.test(nativePrivate.ua);})();nativePrivate.isIos=(function(){return/iphone|ipod/ig.test(nativePrivate.ua);})();if(nativePrivate.isAndroid){try{nativePrivate.qua=JSON.parse(mtt.getBrowserParam());}catch(e){G_helper.errorUploader('script','(isAndroid出错)'+e.toString());}
nativePrivate.isx5=(function(){if(nativePrivate.qua.qua.indexOf('ADRQBX5')!=-1){return true;}else{return false;}})();}}catch(e){G_helper.errorUploader('script','(及预定义)'+e.toString());}}
var onSkinSwitch,onSkinUnzip;window.x5onSkinSwitch=function(skinID){if(!onSkinSwitch){return;}
onSkinSwitch(skinID);};window.x5onSkinUnzip=function(skinID){if(!onSkinUnzip){return;}
onSkinUnzip(skinID);};onSkinUnzip=function(skinID){try{var target=null;_.some(allEle,function(o){if(skinID==o.skinID){target=o;return true;}});if(target&&target.state!='select'){target.state='unselect';target.el.find('.box').removeClass().addClass('box unselect');if(target.skinType==0||target.skinType==1||target.skinType==2){target.el.find('.box').addClass('theme');}}else{return;}}catch(e){G_helper.errorUploader('script','(触发解压完成出错)'+e.toString());}};onSkinSwitch=function(skinID){try{if(selectEle){selectEle.state='unselect';selectEle.el.find('.box').removeClass('select').addClass('unselect');}
var target=null;_.some(allEle,function(o){if(skinID==o.skinID){target=o;return true;}});if(target){target.state='select';target.el.find('.box').removeClass().addClass('box select');if(target.skinType==0||target.skinType==1||target.skinType==2){target.el.find('.box').addClass('theme');}
selectEle=target;}else{selectEle=null;}}catch(e){G_helper.errorUploader('script','(触发换肤出错)'+e.toString());}};var ajax={};ajax.getSkinList=function(url,callback,from,to){try{from=from?from:0;to=to?to:'n';var header={};if(nativePrivate.isAndroid&&nativePrivate.isx5===false){header={"Q-UA":nativePrivate.qua.qua,"Q-GUID":nativePrivate.qua.guid}}
$.ajax({type:'GET',url:url,data:{from:from,to:to},dataType:'json',headers:header,success:function(data){callback(1,data);},error:function(){callback(0);}});}catch(e){G_helper.errorUploader('script','(请求皮肤数据报错)'+e.toString());}};var processLoad=function(o,successback,errorback){try{o.el.find('.box').removeClass('unload').addClass('loading');o.state='loading';var interval=setInterval(function(){nativeAPI.skinDlProgress({skinname:o.skinName,skinid:o.skinID},function(data){var proess=parseInt(data);if(proess<0){clearInterval(interval);if(o.state=='loading'){o.state='unload';o.el.find('.box').removeClass('loading').addClass('unload');};errorback&&errorback(proess);}else if(proess==100){clearInterval(interval);o.el.find('.progress').css('width',proess*0.8+'%');successback&&successback();}else{o.el.find('.progress').css('width',proess*0.8+'%');}},predef.errFunc)},300);}catch(e){G_helper.errorUploader('script','(处理下载进度出错)'+e.toString());}}
var skinUl=$('#skinUl');var loadingEl=$('#loading');_.templateSettings={evaluate:/\{%([\s\S]+?)%\}/g,interpolate:/\{%=([\s\S]+?)%\}/g,escape:/\{%-([\s\S]+?)%\}/g};var dataCount=0;var allEle=[];var selectEle=null;var isDataEnd=false;var isLoading=false;var GetRequest=function(){var url=location.search;var theRequest=new Object();if(url.indexOf("?")!=-1){var str=url.substr(1);if(str.indexOf("&")!=-1){var strs=str.split("&");for(var i=0;i<strs.length;i++){theRequest[strs[i].split("=")[0]]=decodeURI(strs[i].split("=")[1]);}}else{theRequest[str.split("=")[0]]=decodeURI(str.split("=")[1]);}}
return theRequest;};var request=GetRequest();var gatherid=request['gatherid'];var oid=request['oid'];var t=request['t'];var loadData=function(callback,from,to){try{if(isDataEnd||isLoading){return false;}
isLoading=true;var getDataUrl=location.protocol+'//'+location.host+'/skin/getSkinData?tid='+gatherid;ajax.getSkinList(getDataUrl,function(state,data){try{isLoading=false;if(state==0||!data){return false;}
if(from==0){var globalLoadingEl=$('#globalLoading');globalLoadingEl.css('display','none');loadingEl.show();}
if(data.isEnd==1){isDataEnd=true;loadingEl.hide();if(from==0&&data.skins.length==0){}}
dataCount=to;callback(data);}catch(e){G_helper.errorUploader('script','(处理皮肤数据出错)'+e.toString());}},from,to-1);}catch(e){G_helper.errorUploader('script','(拉取皮肤数据封装出错)'+e.toString());}};var composeDate=function(datas){try{var template=_.template($('#skinListTmp').html());var orgSkins=datas.skins;var count=0;var dledSkins;var dlingSkins;var selectID;var composeWithNative=function(){if(count!==3){return;}
var packEl=$();_.each(orgSkins,function(o){o.state='unload';if(nativePrivate.isAndroid){o.skinID=o.skinName;}
var dom=template(o);o.el=$(dom);_.some(dledSkins,function(id){if(o.skinID==id){o.state='unselect';if(o.skinID==selectID){o.state='select';selectEle=o;}
return true;}});_.some(dlingSkins,function(id){if(o.skinID==id){var load=new processLoad(o,function(){load=null;},function(){load=null;});return true;}});if(o.skinType==0||o.skinType==1||o.skinType==2){o.el.find('.box').addClass('theme');}
if(nativePrivate.isAndroid){var skinLinkUrl=location.protocol+'//'+location.host+'/skin/detail.html?isnewpage=true&titlename='+o.name+'&skinid='+o.realID+'&oid='+gatherid;skinLinkUrl=encodeURI(skinLinkUrl);o.el.find('#skinLink').attr("href",skinLinkUrl);}
o.el.find('.box').addClass(o.state);packEl=packEl.add(o.el);});skinUl.append(packEl);allEle=allEle.concat(orgSkins);};nativeAPI.dledSkinList(predef.empty,function(data){dledSkins=data.split('&');count++;composeWithNative();},predef.errFunc);nativeAPI.dlingSkinList(predef.empty,function(data){dlingSkins=data.split('&');count++;composeWithNative();},predef.errFunc);nativeAPI.useingSkinName(predef.empty,function(data){selectID=data;count++;composeWithNative();},predef.errFunc)}catch(e){G_helper.errorUploader('script','(把皮肤与native结合出错)'+e.toString());}};var bindClickEvent=function(){try{if(nativePrivate.isIos){skinUl.on('click','li',function(e){e.preventDefault();var id=$(this).attr('skin-id');var target=null;_.some(allEle,function(o){if(id==o.skinID){target=o;return true;}});if(!target){return false;}
if(nativePrivate.isIos){var urlDetail=location.protocol+'//'+location.host+'/skin/detail.html?&skinid='+target.realID+'&oid='+gatherid;var options={url:urlDetail,title:target.skinName};nativeAPI.openNewPage(options,predef.nullFunc,predef.nullFunc);}});}}catch(e){G_helper.errorUploader('script','(click事件绑定出错)'+e.toString());}};var initData=function(){loadData(function(data){composeDate(data);},dataCount,dataCount+8);};initData();if(t==undefined){G_helper.countUploader(1,gatherid,oid);}else{G_helper.countUploader(t,gatherid,oid);}
bindClickEvent();$(window).on('scroll resize',function(){if(isDataEnd||isLoading){return false;}
var bodyHeight=$('body').height();var winHeight=window.innerHeight;if(bodyHeight-winHeight<=$(window).scrollTop()+52){initData();}});};showGather();